<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èªéŸ³åŠŸèƒ½æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        #voice-button {
            padding: 15px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        #voice-button:hover {
            background-color: #218838;
            transform: scale(1.05);
        }
        #voice-button.recording {
            background-color: #dc3545;
            animation: pulse-recording 1.5s infinite;
        }
        @keyframes pulse-recording {
            0% { background-color: #dc3545; transform: scale(1); }
            50% { background-color: #ff6b7d; transform: scale(1.1); }
            100% { background-color: #dc3545; transform: scale(1); }
        }
        #test-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }
        #debug-info {
            background-color: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .error {
            color: red;
            background-color: #ffeaea;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: green;
            background-color: #eafff0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>

<h1>ğŸ¤ èªéŸ³è­˜åˆ¥åŠŸèƒ½æ¸¬è©¦</h1>

<div>
    <button id="voice-button" title="é»æ“Šæ¸¬è©¦èªéŸ³åŠŸèƒ½">ğŸ¤ é–‹å§‹èªéŸ³è¼¸å…¥</button>
    <button id="lang-toggle">åˆ‡æ›èªè¨€ (ç•¶å‰: ç¹é«”ä¸­æ–‡)</button>
</div>

<input type="text" id="test-input" placeholder="èªéŸ³è­˜åˆ¥çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡...">

<div id="debug-info">æº–å‚™ä¸­...</div>

<script>
    let recognition = null;
    let isRecording = false;
    let currentLang = 'zh-TW';
    
    const voiceButton = document.getElementById('voice-button');
    const langToggle = document.getElementById('lang-toggle');
    const testInput = document.getElementById('test-input');
    const debugInfo = document.getElementById('debug-info');
    
    function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logMessage = `[${timestamp}] ${message}\n`;
        
        if (type === 'error') {
            debugInfo.innerHTML = `<div class="error">${logMessage}</div>` + debugInfo.innerHTML;
            console.error(message);
        } else if (type === 'success') {
            debugInfo.innerHTML = `<div class="success">${logMessage}</div>` + debugInfo.innerHTML;
            console.log(message);
        } else {
            debugInfo.textContent = logMessage + debugInfo.textContent;
            console.log(message);
        }
    }
    
    // åˆå§‹åŒ–èªéŸ³è­˜åˆ¥
    function initSpeechRecognition() {
        log('æ­£åœ¨åˆå§‹åŒ–èªéŸ³è­˜åˆ¥...');
        
        if (!('webkitSpeechRecognition' in window)) {
            log('âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API', 'error');
            voiceButton.disabled = true;
            voiceButton.textContent = 'ğŸš« ä¸æ”¯æ´';
            return null;
        }
        
        try {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = currentLang;
            
            log('âœ… èªéŸ³è­˜åˆ¥åˆå§‹åŒ–æˆåŠŸ', 'success');
            return recognition;
        } catch (error) {
            log(`âŒ åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
            return null;
        }
    }
    
    // è¨­ç½®äº‹ä»¶ç›£è½å™¨
    function setupEvents() {
        if (!recognition) return;
        
        recognition.onstart = function() {
            log('ğŸ¤ èªéŸ³è­˜åˆ¥å·²å•Ÿå‹•', 'success');
        };
        
        recognition.onresult = function(event) {
            let transcript = '';
            for (let i = 0; i < event.results.length; i++) {
                transcript += event.results[i][0].transcript;
            }
            testInput.value = transcript;
            log(`ğŸ“ è­˜åˆ¥çµæœ: ${transcript}`);
        };
        
        recognition.onend = function() {
            log('ğŸ›‘ èªéŸ³è­˜åˆ¥å·²çµæŸ');
            if (isRecording) {
                // é‡æ–°å•Ÿå‹•
                try {
                    recognition.start();
                    log('ğŸ”„ é‡æ–°å•Ÿå‹•èªéŸ³è­˜åˆ¥');
                } catch (error) {
                    log(`âŒ é‡æ–°å•Ÿå‹•å¤±æ•—: ${error.message}`, 'error');
                    stopRecognition();
                }
            }
        };
        
        recognition.onerror = function(event) {
            log(`âŒ èªéŸ³è­˜åˆ¥éŒ¯èª¤: ${event.error}`, 'error');
            if (event.error !== 'no-speech') {
                stopRecognition();
            }
        };
    }
    
    // é–‹å§‹éŒ„éŸ³
    function startRecognition() {
        if (!recognition || isRecording) return;
        
        log('ğŸ¯ å˜—è©¦é–‹å§‹èªéŸ³è­˜åˆ¥...');
        
        // è«‹æ±‚éº¥å…‹é¢¨æ¬Šé™
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(() => {
                log('âœ… éº¥å…‹é¢¨æ¬Šé™ç²å¾—', 'success');
                
                isRecording = true;
                voiceButton.classList.add('recording');
                voiceButton.textContent = 'ğŸ”´ åœæ­¢éŒ„éŸ³';
                
                try {
                    recognition.start();
                    log('ğŸš€ èªéŸ³è­˜åˆ¥å·²å•Ÿå‹•');
                } catch (error) {
                    log(`âŒ å•Ÿå‹•å¤±æ•—: ${error.message}`, 'error');
                    stopRecognition();
                }
            })
            .catch((error) => {
                log(`âŒ éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•: ${error.message}`, 'error');
            });
    }
    
    // åœæ­¢éŒ„éŸ³
    function stopRecognition() {
        log('â¹ï¸ åœæ­¢èªéŸ³è­˜åˆ¥');
        
        isRecording = false;
        voiceButton.classList.remove('recording');
        voiceButton.textContent = 'ğŸ¤ é–‹å§‹èªéŸ³è¼¸å…¥';
        
        if (recognition) {
            try {
                recognition.stop();
            } catch (error) {
                log(`âŒ åœæ­¢éŒ„éŸ³æ™‚å‡ºéŒ¯: ${error.message}`, 'error');
            }
        }
    }
    
    // åˆ‡æ›èªè¨€
    function toggleLanguage() {
        currentLang = currentLang === 'zh-TW' ? 'en-US' : 'zh-TW';
        const langName = currentLang === 'zh-TW' ? 'ç¹é«”ä¸­æ–‡' : 'è‹±æ–‡';
        
        if (recognition) {
            recognition.lang = currentLang;
        }
        
        langToggle.textContent = `åˆ‡æ›èªè¨€ (ç•¶å‰: ${langName})`;
        log(`ğŸŒ èªè¨€å·²åˆ‡æ›ç‚º: ${langName}`, 'success');
    }
    
    // äº‹ä»¶ç›£è½å™¨
    voiceButton.addEventListener('click', () => {
        log('ğŸ‘† èªéŸ³æŒ‰éˆ•è¢«é»æ“Š');
        if (isRecording) {
            stopRecognition();
        } else {
            startRecognition();
        }
    });
    
    langToggle.addEventListener('click', toggleLanguage);
    
    // åˆå§‹åŒ–
    log('ğŸš€ é–‹å§‹åˆå§‹åŒ–èªéŸ³åŠŸèƒ½...');
    recognition = initSpeechRecognition();
    if (recognition) {
        setupEvents();
        log('âœ… èªéŸ³åŠŸèƒ½æº–å‚™å®Œæˆï¼é»æ“ŠæŒ‰éˆ•é–‹å§‹æ¸¬è©¦ã€‚', 'success');
    } else {
        log('âŒ èªéŸ³åŠŸèƒ½åˆå§‹åŒ–å¤±æ•—', 'error');
    }
</script>

</body>
</html>